{% extends 'layouts/dashboard.twig' %}

{% block title %}Theme Setup{% endblock %}
{% block page_title %}Theme Setup{% endblock %}

{% block content %}
<div class="w-full">
    <div class="card bg-base-100 border border-base-300">
        <div class="admin-card-body">
            <h2 class="card-title mb-4">Theme Setup</h2>
            <form method="POST" action="/admin/setup/themes" novalidate>
                <input type="hidden" name="_token" value="{{ csrf_token }}">

                <div class="card bg-base-200/40 border border-base-300 mb-6">
                    <div
                        class="admin-card-body"
                        x-data='{
                            previewOpen: false,
                            selectedTheme: {{ (data.theme ?? shop.theme ?? (themes[0] ?? "default"))|json_encode|raw }},
                            previews: {{ theme_previews|json_encode|raw }}
                        }'
                    >
                        <h3 class="admin-section-title mb-2">Theme</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="admin-form-control">
                                <label class="label" for="theme">
                                    <span class="label-text font-semibold">Select Theme</span>
                                </label>
                                <select
                                    id="theme"
                                    name="theme"
                                    class="admin-select {% if errors.theme %}select-error{% endif %}"
                                    @change="selectedTheme = $event.target.value"
                                >
                                    {% for themeName in themes %}
                                        <option value="{{ themeName }}" {% if (data.theme ?? shop.theme) == themeName %}selected{% endif %}>
                                            {{ themeName|title }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors.theme %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors.theme }}</span>
                                    </label>
                                {% endif %}
                                <p class="text-xs text-base-content/60 mt-2">
                                    Preview updates when you change the theme selection.
                                </p>
                            </div>

                            <div class="border border-base-300 rounded-lg bg-base-100 p-3">
                                <button
                                    type="button"
                                    class="w-full text-left"
                                    @click="if (previews[selectedTheme] && previews[selectedTheme].preview_url) { previewOpen = true; }"
                                >
                                    <div class="aspect-video rounded-lg bg-base-200 flex items-center justify-center overflow-hidden">
                                        <template x-if="previews[selectedTheme] && previews[selectedTheme].preview_url">
                                            <img :src="previews[selectedTheme].preview_url" :alt="(previews[selectedTheme].label || selectedTheme) + ' preview'" class="h-full w-full object-cover" />
                                        </template>
                                        <template x-if="!previews[selectedTheme] || !previews[selectedTheme].preview_url">
                                            <span class="text-xs text-base-content/60">No preview</span>
                                        </template>
                                    </div>
                                    <div class="mt-2">
                                        <p class="font-semibold text-sm" x-text="(previews[selectedTheme] && previews[selectedTheme].label) ? previews[selectedTheme].label : selectedTheme"></p>
                                        <p class="text-xs text-base-content/60" x-text="(previews[selectedTheme] && previews[selectedTheme].description) ? previews[selectedTheme].description : ''"></p>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div
                            x-show="previewOpen"
                            class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-6 overflow-y-auto"
                            @click.self="previewOpen=false"
                            x-transition
                        >
                            <div class="max-w-5xl w-full bg-base-100 rounded-lg p-4 my-auto">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="font-semibold text-base-content" x-text="(previews[selectedTheme] && previews[selectedTheme].label) ? previews[selectedTheme].label : selectedTheme"></p>
                                    <button type="button" class="btn btn-ghost btn-sm" @click="previewOpen=false">Close</button>
                                </div>
                                <div class="aspect-video rounded-lg bg-base-200 overflow-hidden">
                                    <img :src="previews[selectedTheme] ? previews[selectedTheme].preview_url : ''" alt="Theme preview" class="h-full w-full object-cover" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% set theme_values = data.theme_config ?? theme_config ?? {} %}
                {% set theme_colors = theme_values.colors ?? theme_defaults.colors ?? {} %}
                {% set theme_radii = theme_values.radii ?? theme_defaults.radii ?? {} %}
                {% set theme_text_sizes = theme_values.text_sizes ?? theme_defaults.text_sizes ?? {} %}
                {% set selected_font_profile = theme_values.font_profile ?? theme_defaults.font_profile ?? 'system' %}
                {% set selected_font_base = theme_values.font_profile_base ?? theme_defaults.font_profile_base ?? selected_font_profile %}
                {% set selected_font_heading = theme_values.font_profile_heading ?? theme_defaults.font_profile_heading ?? selected_font_profile %}
                {% set selected_font = font_profiles[selected_font_profile] ?? font_profiles.system %}
                {% set selected_font_base_profile = font_profiles[selected_font_base] ?? font_profiles.system %}
                {% set selected_font_heading_profile = font_profiles[selected_font_heading] ?? font_profiles.system %}

                <div class="card bg-base-200/40 border border-base-300 mb-6">
                    <div class="admin-card-body">
                        <h3 class="admin-section-title mb-2">Theme Colors</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for field, meta in {
                                'primary': { 'label': 'Primary', 'help': 'Main buttons and links.' },
                                'primary_content': { 'label': 'Primary Content', 'help': 'Text/icon color on primary.' },
                                'secondary': { 'label': 'Secondary', 'help': 'Secondary actions and accents.' },
                                'secondary_content': { 'label': 'Secondary Content', 'help': 'Text/icon color on secondary.' },
                                'accent': { 'label': 'Accent', 'help': 'Highlights and promo emphasis.' },
                                'accent_content': { 'label': 'Accent Content', 'help': 'Text/icon color on accent.' },
                                'background': { 'label': 'Background', 'help': 'Page background.' },
                                'surface': { 'label': 'Surface', 'help': 'Cards, header, and footer.' },
                                'surface_alt': { 'label': 'Surface Alt', 'help': 'Alternate section backgrounds.' },
                                'text': { 'label': 'Text', 'help': 'Primary body text.' },
                                'text_muted': { 'label': 'Text Muted', 'help': 'Secondary text and labels.' },
                                'border': { 'label': 'Border', 'help': 'Lines and dividers.' },
                                'base_200': { 'label': 'Base 200', 'help': 'Soft surface fill (cards, inputs).' },
                                'base_300': { 'label': 'Base 300', 'help': 'Borders and subtle separators.' }
                            } %}
                                {% set fieldKey = 'theme_config.colors.' ~ field %}
                                {% set colorValue = theme_colors[field] ?? '' %}
                                <div class="admin-form-control">
                                    <label class="label" for="theme_color_picker_{{ field }}">
                                        <span class="label-text font-semibold">{{ meta.label }}</span>
                                    </label>
                                    <p class="text-xs text-base-content/60 -mt-2">{{ meta.help }}</p>
                                    <div class="flex items-center gap-3">
                                        <input
                                            type="color"
                                            name="theme_config[colors][{{ field }}]"
                                            id="theme_color_picker_{{ field }}"
                                            value="{{ colorValue != '' ? colorValue : '#000000' }}"
                                            class="admin-input h-10 w-16 p-1 {% if errors[fieldKey] %}input-error{% endif %}"
                                            aria-label="{{ meta.label }} color picker"
                                            oninput="document.getElementById('theme_color_hex_{{ field }}').textContent = this.value"
                                        />
                                        <span id="theme_color_hex_{{ field }}" class="text-sm text-base-content/70">
                                            {{ colorValue != '' ? colorValue : '#000000' }}
                                        </span>
                                    </div>
                                    {% if errors[fieldKey] %}
                                        <div class="text-xs text-error mt-1">{{ errors[fieldKey] }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <p class="text-xs text-base-content/60 mt-2">Use hex colors like #2563EB. Leave blank to fall back.</p>
                    </div>
                </div>

                <div class="card bg-base-200/40 border border-base-300 mb-6">
                    <script>
                        window.themeFontProfiles = {{ font_profiles|json_encode|raw }};
                    </script>
                    <div class="admin-card-body" x-data="{
                        fontProfiles: window.themeFontProfiles || {},
                        selectedBaseFont: '{{ selected_font_base|e('js') }}',
                        selectedHeadingFont: '{{ selected_font_heading|e('js') }}',
                        getBaseFontCss() {
                            const profile = this.fontProfiles[this.selectedBaseFont] || this.fontProfiles.system;
                            return profile ? (profile.css || 'system-ui, -apple-system, sans-serif') : 'system-ui, -apple-system, sans-serif';
                        },
                        getHeadingFontCss() {
                            const profile = this.fontProfiles[this.selectedHeadingFont] || this.fontProfiles.system;
                            return profile ? (profile.css || 'system-ui, -apple-system, sans-serif') : 'system-ui, -apple-system, sans-serif';
                        }
                    }">
                        <h3 class="admin-section-title mb-2">Typography</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {% set fontBaseFieldKey = 'theme_config.font_profile_base' %}
                            <div class="admin-form-control">
                                <label class="label" for="theme_font_profile_base">
                                    <span class="label-text font-semibold">Base Font Profile</span>
                                </label>
                                <select
                                    id="theme_font_profile_base"
                                    name="theme_config[font_profile_base]"
                                    class="admin-select {% if errors[fontBaseFieldKey] %}select-error{% endif %}"
                                    x-model="selectedBaseFont"
                                >
                                    {% for key, profile in font_profiles %}
                                        <option value="{{ key }}" {% if selected_font_base == key %}selected{% endif %}>
                                            {{ profile.label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors[fontBaseFieldKey] %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors[fontBaseFieldKey] }}</span>
                                    </label>
                                {% endif %}
                                <p class="text-sm text-base-content/70 mt-2" :style="'font-family: ' + getBaseFontCss()">
                                    The quick brown fox jumps over the lazy dog.
                                </p>
                            </div>

                            {% set fontHeadingFieldKey = 'theme_config.font_profile_heading' %}
                            <div class="admin-form-control">
                                <label class="label" for="theme_font_profile_heading">
                                    <span class="label-text font-semibold">Heading Font Profile</span>
                                </label>
                                <select
                                    id="theme_font_profile_heading"
                                    name="theme_config[font_profile_heading]"
                                    class="admin-select {% if errors[fontHeadingFieldKey] %}select-error{% endif %}"
                                    x-model="selectedHeadingFont"
                                >
                                    {% for key, profile in font_profiles %}
                                        <option value="{{ key }}" {% if selected_font_heading == key %}selected{% endif %}>
                                            {{ profile.label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors[fontHeadingFieldKey] %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors[fontHeadingFieldKey] }}</span>
                                    </label>
                                {% endif %}
                                <p class="text-sm text-base-content/70 mt-2" :style="'font-family: ' + getHeadingFontCss()">
                                    The quick brown fox jumps over the lazy dog.
                                </p>
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-base-300">
                            <h4 class="font-semibold text-base-content mb-4">Sample Typography</h4>
                            <div class="card bg-base-100 border border-base-300 p-6">
                                <div>
                                    <h1 class="text-4xl font-bold mb-3" :style="'font-family: ' + getHeadingFontCss()">
                                        Heading 1
                                    </h1>
                                    <h2 class="text-3xl font-semibold mb-4" :style="'font-family: ' + getHeadingFontCss()">
                                        Heading 2
                                    </h2>
                                </div>
                                <div :style="'font-family: ' + getBaseFontCss()" class="space-y-2">
                                    <p class="text-base">
                                        This is a paragraph of text. The quick brown fox jumps over the lazy dog. It demonstrates how regular body text will appear with the selected base font.
                                    </p>
                                    <p class="text-base">
                                        <strong>This is bold text.</strong> It shows how emphasized content will look in your typography.
                                    </p>
                                    <p class="text-base">
                                        <em>This is italic text.</em> It demonstrates the italic style with your selected font.
                                    </p>
                                    <p class="text-base">
                                        <strong><em>This is bold and italic text.</em></strong> Combining both styles for emphasis.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-200/40 border border-base-300 mb-6">
                    <div class="admin-card-body">
                        <h3 class="admin-section-title mb-2">Radii</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {% for field, meta in {
                                'sm': { 'label': 'Small', 'min': 0, 'max': 8, 'step': 1, 'default': 4 },
                                'md': { 'label': 'Medium', 'min': 2, 'max': 16, 'step': 1, 'default': 8 },
                                'lg': { 'label': 'Large', 'min': 4, 'max': 32, 'step': 2, 'default': 12 }
                            } %}
                                {% set fieldKey = 'theme_config.radii.' ~ field %}
                                {% set radiusValue = theme_radii[field] ?? '' %}
                                {% set radiusNumber = radiusValue != '' ? radiusValue|replace({'px': ''}) : meta.default %}
                                <div class="admin-form-control">
                                    <label class="label" for="theme_radius_range_{{ field }}">
                                        <span class="label-text font-semibold">{{ meta.label }}</span>
                                    </label>
                                    <input type="hidden" name="theme_config[radii][{{ field }}]" id="theme_radius_{{ field }}" value="{{ radiusValue }}">
                                    <div class="flex items-center gap-3">
                                        <input
                                            type="range"
                                            id="theme_radius_range_{{ field }}"
                                            min="{{ meta.min }}"
                                            max="{{ meta.max }}"
                                            step="{{ meta.step }}"
                                            value="{{ radiusNumber }}"
                                            class="range range-xs"
                                            oninput="document.getElementById('theme_radius_{{ field }}').value = this.value + 'px'; document.getElementById('theme_radius_value_{{ field }}').textContent = this.value + 'px';"
                                        />
                                        <span id="theme_radius_value_{{ field }}" class="text-sm text-base-content/70">
                                            {{ radiusValue != '' ? radiusValue : (meta.default ~ 'px') }}
                                        </span>
                                    </div>
                                    {% if errors[fieldKey] %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors[fieldKey] }}</span>
                                        </label>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card bg-base-200/40 border border-base-300 mb-6">
                    <div class="admin-card-body">
                        <h3 class="admin-section-title mb-2">Text Sizes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {% set field = 'base' %}
                            {% set meta = { 'label': 'Base', 'min': 12, 'max': 24, 'step': 1, 'default': 16 } %}
                            {% set fieldKey = 'theme_config.text_sizes.' ~ field %}
                            {% set textValue = theme_text_sizes[field] ?? '' %}
                            {% set textNumber = textValue != '' ? textValue|replace({'px': ''}) : meta.default %}
                            <div class="admin-form-control">
                                <label class="label" for="theme_text_range_{{ field }}">
                                    <span class="label-text font-semibold">{{ meta.label }}</span>
                                </label>
                                <input type="hidden" name="theme_config[text_sizes][{{ field }}]" id="theme_text_{{ field }}" value="{{ textValue }}">
                                <div class="flex items-center gap-3">
                                    <input
                                        type="range"
                                        id="theme_text_range_{{ field }}"
                                        min="{{ meta.min }}"
                                        max="{{ meta.max }}"
                                        step="{{ meta.step }}"
                                        value="{{ textNumber }}"
                                        class="range range-xs"
                                        oninput="document.getElementById('theme_text_{{ field }}').value = this.value + 'px'; document.getElementById('theme_text_value_{{ field }}').textContent = this.value + 'px';"
                                    />
                                    <span id="theme_text_value_{{ field }}" class="text-sm text-base-content/70">
                                        {{ textValue != '' ? textValue : (meta.default ~ 'px') }}
                                    </span>
                                </div>
                                {% if errors[fieldKey] %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors[fieldKey] }}</span>
                                    </label>
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-xs text-base-content/60 mt-2">Use CSS units (px, rem, em, %).</p>
                    </div>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" name="reset_theme" value="1" class="btn btn-outline btn-sm">Reset Theme</button>
                    <button type="submit" class="btn btn-primary btn-sm">Save Theme Settings</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
