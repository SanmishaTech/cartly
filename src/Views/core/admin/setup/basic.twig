{% extends 'layouts/dashboard.twig' %}

{% block title %}Basic Setup{% endblock %}
{% block page_title %}Basic Setup{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
{% endblock %}

{% block content %}
<div class="w-full">
    <div class="card bg-base-100 border border-base-300">
        <div class="admin-card-body">
            <h2 class="card-title mb-4">Basic Setup</h2>
            <form method="POST" action="/admin/setup/basic" enctype="multipart/form-data" novalidate>
                <input type="hidden" name="_token" value="{{ csrf_token }}">

                <div class="admin-form-grid mb-6">
                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Brand</h3>
                            <div class="admin-form-control">
                                <label class="label" for="shop_name">
                                    <span class="label-text font-semibold">Shop Name</span>
                                    <span class="text-error">*</span>
                                </label>
                                <input
                                    type="text"
                                    name="shop_name"
                                    id="shop_name"
                                    value="{{ data.shop_name ?? shop.shop_name ?? '' }}"
                                    class="admin-input {% if errors.shop_name %}input-error{% endif %}"
                                    required
                                />
                                {% if errors.shop_name %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors.shop_name }}</span>
                                    </label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control">
                                <label class="label" for="shop_description">
                                    <span class="label-text font-semibold">Shop Description</span>
                                </label>
                                <textarea
                                    name="shop_description"
                                    id="shop_description"
                                    class="admin-textarea {% if errors.shop_description %}textarea-error{% endif %}"
                                    rows="3"
                                >{{ data.shop_description ?? shop.shop_description ?? '' }}</textarea>
                                {% if errors.shop_description %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors.shop_description }}</span>
                                    </label>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Branding Assets (WebP)</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="admin-form-control">
                                    <label class="label" for="logo">
                                        <span class="label-text font-semibold">Logo (512x512)</span>
                                    </label>
                                    <input
                                        type="file"
                                        name="logo"
                                        id="logo"
                                        accept="image/png,image/jpeg,image/webp"
                                        class="file-input file-input-bordered w-full"
                                    />
                                <p class="text-xs text-base-content/60 mt-1">We convert uploads to WebP.</p>
                                    <img
                                        src="{% if shop.logo_path %}/media/{{ shop.logo_path }}{% endif %}"
                                        alt="Logo preview"
                                        class="mt-2 h-16 w-16 rounded bg-base-200 object-cover {% if not shop.logo_path %}hidden{% endif %}"
                                        data-preview="logo"
                                    />
                                    {% if errors.logo %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.logo }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="admin-form-control">
                                    <label class="label" for="favicon">
                                        <span class="label-text font-semibold">Favicon (64x64)</span>
                                    </label>
                                    <input
                                        type="file"
                                        name="favicon"
                                        id="favicon"
                                        accept="image/png,image/jpeg,image/webp"
                                        class="file-input file-input-bordered w-full"
                                    data-crop-target="favicon"
                                    data-crop-ratio="1"
                                    />
                                <p class="text-xs text-base-content/60 mt-1">We crop to 64x64 and convert to WebP.</p>
                                    <img
                                        src="{% if shop.favicon_path %}/media/{{ shop.favicon_path }}{% endif %}"
                                        alt="Favicon preview"
                                        class="mt-2 h-10 w-10 rounded bg-base-200 object-cover {% if not shop.favicon_path %}hidden{% endif %}"
                                        data-preview="favicon"
                                    />
                                    {% if errors.favicon %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.favicon }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                            </div>

                            {% if errors.uploads %}
                                <div class="mt-2 text-sm text-error">{{ errors.uploads }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Address</h3>
                            <div class="admin-form-control">
                                <label class="label" for="address_line1">
                                    <span class="label-text font-semibold">Address Line 1</span>
                                </label>
                                <input
                                    type="text"
                                    name="address_line1"
                                    id="address_line1"
                                    value="{{ data.address_line1 ?? shop.address_line1 ?? '' }}"
                                    class="admin-input {% if errors.address_line1 %}input-error{% endif %}"
                                />
                                {% if errors.address_line1 %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors.address_line1 }}</span>
                                    </label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control">
                                <label class="label" for="address_line2">
                                    <span class="label-text font-semibold">Address Line 2</span>
                                </label>
                                <input
                                    type="text"
                                    name="address_line2"
                                    id="address_line2"
                                    value="{{ data.address_line2 ?? shop.address_line2 ?? '' }}"
                                    class="admin-input {% if errors.address_line2 %}input-error{% endif %}"
                                />
                                {% if errors.address_line2 %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ errors.address_line2 }}</span>
                                    </label>
                                {% endif %}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="admin-form-control">
                                    <label class="label" for="city">
                                        <span class="label-text font-semibold">City</span>
                                    </label>
                                    <input
                                        type="text"
                                        name="city"
                                        id="city"
                                        value="{{ data.city ?? shop.city ?? '' }}"
                                        class="admin-input {% if errors.city %}input-error{% endif %}"
                                    />
                                    {% if errors.city %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.city }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="admin-form-control">
                                    <label class="label" for="state">
                                        <span class="label-text font-semibold">State</span>
                                    </label>
                                    <input
                                        type="text"
                                        name="state"
                                        id="state"
                                        value="{{ data.state ?? shop.state ?? '' }}"
                                        class="admin-input {% if errors.state %}input-error{% endif %}"
                                    />
                                    {% if errors.state %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.state }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="admin-form-control">
                                    <label class="label" for="postal_code">
                                        <span class="label-text font-semibold">Postal Code</span>
                                    </label>
                                    <input
                                        type="text"
                                        name="postal_code"
                                        id="postal_code"
                                        value="{{ data.postal_code ?? shop.postal_code ?? '' }}"
                                        class="admin-input {% if errors.postal_code %}input-error{% endif %}"
                                    />
                                    {% if errors.postal_code %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.postal_code }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="admin-form-control">
                                    <label class="label" for="country">
                                        <span class="label-text font-semibold">Country</span>
                                    </label>
                                    <input
                                        type="text"
                                        name="country"
                                        id="country"
                                        value="{{ data.country ?? shop.country ?? 'India' }}"
                                        class="admin-input {% if errors.country %}input-error{% endif %}"
                                    />
                                    {% if errors.country %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ errors.country }}</span>
                                        </label>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="btn btn-primary btn-sm">Save Basic Setup</button>
                </div>
            </form>
        </div>
    </div>
</div>

<dialog id="cropModal" class="modal">
    <div class="modal-box max-w-5xl h-[85vh] p-0 flex flex-col">
        <div class="flex items-center justify-between border-b border-base-300 px-6 py-4 bg-base-100/80">
            <h3 class="font-semibold text-lg">Crop Image</h3>
        </div>
        <div class="px-6 py-4 flex-1 overflow-hidden">
            <div
                class="border border-base-300 rounded-lg bg-base-200/40 w-full"
                style="height: calc(85vh - 220px);"
            >
                <img
                    id="cropImage"
                    src=""
                    alt="Crop preview"
                    style="max-width:100%; max-height:100%; display:block;"
                />
            </div>
        </div>
        <div class="flex items-center justify-between gap-2 border-t border-base-300 px-6 py-4 bg-base-100/80">
            <p class="text-xs text-base-content/60">Tip: Use your mouse wheel to zoom.</p>
            <form method="dialog" class="flex gap-2">
                <button class="btn btn-ghost btn-sm">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="applyCrop">Apply Crop</button>
            </form>
        </div>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
    <script>
        (function () {
            var cropModal = document.getElementById('cropModal');
            var cropImage = document.getElementById('cropImage');
            var applyButton = document.getElementById('applyCrop');
            var activeInput = null;
            var activePreview = null;
            var cropper = null;
            var activeRatio = 1;

            function openCropper(file, ratio, preview) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    cropImage.src = event.target.result;
                    cropModal.showModal();
                    activeRatio = ratio;
                    activePreview = preview;
                    setTimeout(function () {
                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(cropImage, {
                            aspectRatio: activeRatio,
                            viewMode: 1,
                            autoCropArea: 1,
                            dragMode: 'move',
                        });
                    }, 50);
                };
                reader.readAsDataURL(file);
            }

            document.querySelectorAll('[data-crop-target]').forEach(function (input) {
                input.addEventListener('change', function (event) {
                    var file = event.target.files && event.target.files[0];
                    if (!file) {
                        return;
                    }
                    activeInput = event.target;
                    var ratio = parseFloat(event.target.getAttribute('data-crop-ratio')) || 1;
                    var preview = document.querySelector('[data-preview="' + event.target.getAttribute('data-crop-target') + '"]');
                    openCropper(file, ratio, preview);
                });
            });

            applyButton.addEventListener('click', function () {
                if (!cropper || !activeInput) {
                    return;
                }
                cropper.getCroppedCanvas().toBlob(function (blob) {
                    if (!blob) {
                        return;
                    }
                    var file = new File([blob], 'cropped.webp', { type: 'image/webp' });
                    var dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    activeInput.files = dataTransfer.files;
                    if (activePreview) {
                        activePreview.src = URL.createObjectURL(blob);
                        activePreview.classList.remove('hidden');
                    }
                    cropModal.close();
                    cropper.destroy();
                    cropper = null;
                }, 'image/webp', 0.9);
            });

        })();
    </script>
{% endblock %}
