{% extends 'layouts/dashboard.twig' %}

{% block title %}Edit User{% endblock %}
{% block page_title %}Edit User{% endblock %}

{% block content %}
<div class="w-full">
    <div class="card bg-base-100 border border-base-300">
        <div class="admin-card-body">
            <h2 class="card-title mb-4">Edit User</h2>
            <form method="POST" action="/admin/users/{{ user.id }}/update" novalidate>
                <input type="hidden" name="_token" value="{{ csrf_token }}">

                <div class="admin-form-grid mb-6">
                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Identity</h3>

                            <div class="admin-form-control">
                                <label class="label" for="user_email">
                                    <span class="label-text font-semibold">Email</span>
                                    <span class="text-error">*</span>
                                </label>
                                <input
                                    type="email"
                                    id="user_email"
                                    name="email"
                                    value="{{ data.email ?? user.email }}"
                                    class="admin-input {% if errors.email %}input-error{% endif %}"
                                    required
                                />
                                {% if errors.email %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.email }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control">
                                <label class="label" for="user_password">
                                    <span class="label-text font-semibold">Set password</span>
                                </label>
                                <input
                                    type="password"
                                    id="user_password"
                                    name="password"
                                    class="admin-input {% if errors.password %}input-error{% endif %}"
                                    placeholder="Leave blank to keep current password"
                                />
                                {% if errors.password %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.password }}</span></label>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Access</h3>

                            <div class="admin-form-control">
                                <label class="label" for="user_global_role">
                                    <span class="label-text font-semibold">Global role</span>
                                </label>
                                <select
                                    id="user_global_role"
                                    name="global_role"
                                    class="admin-select {% if errors.global_role %}select-error{% endif %}"
                                    data-global-role
                                >
                                    {% set currentGlobalRole = data.global_role ?? user.global_role ?? '' %}
                                    {% for value, label in global_roles %}
                                        <option value="{{ value }}" {% if currentGlobalRole == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if errors.global_role %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.global_role }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control" data-shop-wrapper>
                                <label class="label" for="user_shop_id">
                                    <span class="label-text font-semibold">Linked shop</span>
                                    <span class="text-error" data-shop-required>*</span>
                                </label>
                                <select
                                    id="user_shop_id"
                                    name="shop_id"
                                    class="admin-select {% if errors.shop_id %}select-error{% endif %}"
                                    data-shop-select
                                >
                                    <option value="">No shop</option>
                                    {% set currentShopId = data.shop_id ?? (primary_membership ? primary_membership.shop_id : '') %}
                                    {% for shopOption in shops %}
                                        <option value="{{ shopOption.id }}" {% if currentShopId == shopOption.id %}selected{% endif %}>{{ shopOption.shop_name }}</option>
                                    {% endfor %}
                                </select>
                                {% if errors.shop_id %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.shop_id }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control" data-shop-wrapper>
                                <label class="label" for="user_shop_role">
                                    <span class="label-text font-semibold">Shop role</span>
                                </label>
                                <select
                                    id="user_shop_role"
                                    name="shop_role"
                                    class="admin-select {% if errors.shop_role %}select-error{% endif %}"
                                    data-shop-role
                                >
                                    {% set currentShopRole = data.shop_role ?? (primary_membership ? primary_membership.role : 'owner') %}
                                    {% for role in shop_roles %}
                                        <option value="{{ role }}" {% if currentShopRole == role %}selected{% endif %}>{{ role|capitalize }}</option>
                                    {% endfor %}
                                </select>
                                {% if errors.shop_role %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.shop_role }}</span></label>
                                {% endif %}
                            </div>
                            <p class="text-xs text-base-content/60 mt-2">
                                Either set a global role (root/helpdesk) or link the user to a shop with a role.
                            </p>

                            <div class="admin-form-control">
                                <label class="label" for="user_status">
                                    <span class="label-text font-semibold">Status</span>
                                    <span class="text-error">*</span>
                                </label>
                                <select
                                    id="user_status"
                                    name="status"
                                    class="admin-select {% if errors.status %}select-error{% endif %}"
                                    required
                                >
                                    {% set currentStatus = data.status ?? user.status %}
                                    <option value="active" {% if currentStatus == 'active' %}selected{% endif %}>Active</option>
                                    <option value="inactive" {% if currentStatus == 'inactive' %}selected{% endif %}>Inactive</option>
                                </select>
                                {% if errors.status %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.status }}</span></label>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-form-actions">
                    <a href="/admin/users" class="btn btn-sm bg-base-200 hover:bg-base-300 border-base-300">Cancel</a>
                    <button type="submit" class="btn btn-primary btn-sm">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    (function () {
        var globalRoleSelect = document.querySelector('[data-global-role]');
        var shopSelect = document.querySelector('[data-shop-select]');
        var shopRequired = document.querySelector('[data-shop-required]');
        if (!globalRoleSelect || !shopSelect) return;

        function toggleShop() {
            var globalRole = globalRoleSelect.value;
            var hasGlobalRole = globalRole === 'root' || globalRole === 'helpdesk';
            shopSelect.disabled = hasGlobalRole;
            shopSelect.required = !hasGlobalRole;
            if (shopRequired) shopRequired.style.display = hasGlobalRole ? 'none' : '';
            if (hasGlobalRole) shopSelect.value = '';
        }

        globalRoleSelect.addEventListener('change', toggleShop);
        toggleShop();
    })();
</script>
{% endblock %}
