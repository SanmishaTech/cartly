{% extends 'layouts/dashboard.twig' %}

{% block title %}Create User{% endblock %}
{% block page_title %}Create User{% endblock %}

{% block content %}
<div class="w-full">
    <div class="card bg-base-100 border border-base-300">
        <div class="admin-card-body">
            <h2 class="card-title mb-4">Create User</h2>
            <form method="POST" action="/admin/users/store" novalidate>
                <input type="hidden" name="_token" value="{{ csrf_token }}">

                <div class="admin-form-grid mb-6">
                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">User Details</h3>

                            <div class="admin-form-control">
                                <label class="label" for="user_name">
                                    <span class="label-text font-semibold">Name</span>
                                    <span class="text-error">*</span>
                                </label>
                                <input
                                    type="text"
                                    id="user_name"
                                    name="name"
                                    value="{{ data.name ?? '' }}"
                                    class="admin-input {% if errors.name %}input-error{% endif %}"
                                    required
                                />
                                {% if errors.name %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.name }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control">
                                <label class="label" for="user_email">
                                    <span class="label-text font-semibold">Email</span>
                                    <span class="text-error">*</span>
                                </label>
                                <input
                                    type="email"
                                    id="user_email"
                                    name="email"
                                    value="{{ data.email ?? '' }}"
                                    class="admin-input {% if errors.email %}input-error{% endif %}"
                                    required
                                />
                                {% if errors.email %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.email }}</span></label>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200/40 border border-base-300">
                        <div class="admin-card-body">
                            <h3 class="admin-section-title mb-2">Access</h3>

                            <div class="admin-form-control">
                                <label class="label" for="user_role">
                                    <span class="label-text font-semibold">Role</span>
                                    <span class="text-error">*</span>
                                </label>
                                <select
                                    id="user_role"
                                    name="role"
                                    class="admin-select {% if errors.role %}select-error{% endif %}"
                                    required
                                    data-user-role
                                >
                                    {% set currentRole = data.role ?? '' %}
                                    <option value="">Select role</option>
                                    {% for role in roles %}
                                        <option value="{{ role }}" {% if currentRole == role %}selected{% endif %}>
                                            {{ role|replace({'_': ' '})|capitalize }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors.role %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.role }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control" data-shop-wrapper>
                                <label class="label" for="user_shop_id">
                                    <span class="label-text font-semibold">Linked Shop</span>
                                    <span class="text-error" data-shop-required>*</span>
                                </label>
                                <select
                                    id="user_shop_id"
                                    name="shop_id"
                                    class="admin-select {% if errors.shop_id %}select-error{% endif %}"
                                    data-shop-select
                                >
                                    <option value="">No shop</option>
                                    {% set currentShop = data.shop_id ?? '' %}
                                    {% for shop in shops %}
                                        <option value="{{ shop.id }}" {% if currentShop == shop.id %}selected{% endif %}>
                                            {{ shop.shop_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors.shop_id %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.shop_id }}</span></label>
                                {% endif %}
                            </div>
                            <p class="text-xs text-base-content/60 mt-2">
                                Root and helpdesk users are not linked to shops.
                            </p>

                            <div class="admin-form-control">
                                <label class="label" for="user_status">
                                    <span class="label-text font-semibold">Status</span>
                                    <span class="text-error">*</span>
                                </label>
                                <select
                                    id="user_status"
                                    name="status"
                                    class="admin-select {% if errors.status %}select-error{% endif %}"
                                    required
                                >
                                    {% set currentStatus = data.status ?? 'active' %}
                                    <option value="active" {% if currentStatus == 'active' %}selected{% endif %}>Active</option>
                                    <option value="inactive" {% if currentStatus == 'inactive' %}selected{% endif %}>Inactive</option>
                                </select>
                                {% if errors.status %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.status }}</span></label>
                                {% endif %}
                            </div>

                            <div class="admin-form-control">
                                <label class="label" for="user_password">
                                    <span class="label-text font-semibold">Password</span>
                                    <span class="text-error">*</span>
                                </label>
                                <input
                                    type="password"
                                    id="user_password"
                                    name="password"
                                    class="admin-input {% if errors.password %}input-error{% endif %}"
                                    placeholder="Minimum 6 characters"
                                    required
                                />
                                {% if errors.password %}
                                    <label class="label"><span class="label-text-alt text-error">{{ errors.password }}</span></label>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-form-actions">
                    <a href="/admin/users" class="btn btn-sm bg-base-200 hover:bg-base-300 border-base-300">Cancel</a>
                    <button type="submit" class="btn btn-primary btn-sm">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    (function () {
        var roleSelect = document.querySelector('[data-user-role]');
        var shopSelect = document.querySelector('[data-shop-select]');
        if (!roleSelect || !shopSelect) {
            return;
        }

        function toggleShop() {
            var role = roleSelect.value;
            var disableShop = role === 'root' || role === 'helpdesk';
            shopSelect.disabled = disableShop;
            shopSelect.required = !disableShop;
            if (disableShop) {
                shopSelect.value = '';
            }
        }

        roleSelect.addEventListener('change', toggleShop);
        toggleShop();
    })();
</script>
{% endblock %}
